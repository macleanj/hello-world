kind: Pod
metadata:
  name: jnlp
  annotations:
    container.apparmor.security.beta.kubernetes.io/jenkins-builder: unconfined
    # container.seccomp.security.alpha.kubernetes.io/jenkins-builder: unconfined
spec:
  # securityContext:
  #   runAsUser: 1000
  # serviceAccountName: jenkins
  initContainers:
    - name: volume-permissions
      image: busybox
      command: ['sh', '-c', 'chmod -R g+rwX /build-volume']
      volumeMounts:
      - mountPath: /build-volume
        name: git-repo
  containers:
  - name: jnlp
    image: jenkins/jnlp-slave:3.40-1
    # image: jenkins/jnlp-slave:4.0.1-1
    # resources:
    #   limits:
    #     cpu: 1
    #     memory: 2Gi
    #   requests:
    #     cpu: 0.5
    #     memory: 1Gi
  - name: jenkins-builder
    # workingDir: /build-volume # Repo needs to be copied into the volume in the job
    workingDir: /home/jenkins/agent
    image: r.j3ss.co/img:v0.5.6
    imagePullPolicy: Always
    securityContext:
      runAsUser: 1000
      rawProc: true
    #   allowPrivilegeEscalation: false
    #   readOnlyRootFilesystem: true
    #   privileged: true
    resources:
      requests:
        memory: "64Mi"
        cpu: "250m"
      limits:
        memory: "128Mi"
        cpu: "500m"
    command:
    - cat
    tty: true 
    volumeMounts:
      - name: cache-volume
        mountPath: /tmp
      - name: git-repo
        mountPath: /build-volume # Repo needs to be copied into the volume in the job
  volumes:
  - name: cache-volume
    emptyDir: {}
  - name: git-repo
    emptyDir: {}
